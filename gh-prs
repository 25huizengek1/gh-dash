#!/bin/bash

set -eo pipefail

POSITIONAL=()
REPOS=()

while [[ $# -gt 0 ]]; do
  key="$1"

  case $key in
    -r|--repo)
      REPOS+=($2)
      shift
      shift
      ;;
    *)
      POSITIONAL+=("$1")
      shift
      ;;
  esac
done

if [ ${#@} -ne 0 ] && [ "${@#"--help"}" = "" ]; then
  printf -- 'Help:\n'
  printf -- 'Coming soon...\n'
  exit 0
fi

fields="title,mergeable,author,url,additions,headRefName,headRepository,isDraft,number,reviewDecision,state,statusCheckRollup,updatedAt" 
title_max_len=35
bold=$(echo -e "\033[1m")
normal=$(echo -e "\033[0m")
underline=$(echo -e "\033[4m")

fetch_filtered_prs() {
  printf "\n${bold}$1${normal}\n\n"
  pr_lines=""
  for repo in "${REPOS[@]}"
  do
    lines_to_add=$(
      gh pr list \
        --limit 10 \
        --repo "${repo}" \
        --search "$2 sort:updated-desc" \
        --json "${fields}" \
        --template "$(cat template.txt | xargs)" \
    )
    pr_lines=$(echo -e "${pr_lines}${lines_to_add}" | sed 's/^[[:blank:]]*//')
  done

  trimmed=$(echo $pr_lines | tr -s " ")
  if [ -z "$trimmed" ]
  then
    echo "No PRs matching the given filters..."
  else
    header=$(echo "${normal}${normal}${normal}${underline}Status |  Title |  Repo |  Author |  Last Updated |  URL${normal}")
    echo -e "$header\n$pr_lines" | column -s '|' -t
  fi
}

fetch_filtered_prs "My Pull Requests" author:@me
fetch_filtered_prs "Needs My Review" assignee:@me
fetch_filtered_prs "Subscribed" -author:@me

