#!/bin/bash

set -eo pipefail

source './spinner.sh'

POSITIONAL=()
REPOS=()

programname="gh prs";
function usage {
    echo "";
    echo "Usage:"
    echo "  $programname [repos...]"
    echo ""
    echo "OPTIONS"
    echo "    -h, --help             display help"
    echo "    -r, --repo repo-name   specify a repo to fetch PRs for"
    echo ""
    echo "EXAMPLE"
    echo "  $programname -r dlvhdr/gh-prs -r cli/cli"
    echo "";
    exit 0
}

while [[ $# -gt 0 ]]; do
  key="$1"

  case $key in
    -h|--help)
      usage
      ;;
    -r|--repo)
      REPOS+=($2)
      shift
      shift
      ;;
    *)
      POSITIONAL+=("$1")
      shift
      ;;
  esac
done

if [ ${#@} -ne 0 ] && [ "${@#"--help|"}" = "" ]; then
  usage
fi

fields="title,mergeable,author,url,additions,headRefName,headRepository,isDraft,number,reviewDecision,state,statusCheckRollup,updatedAt" 
title_max_len=35
bold=$(echo -e "\033[1m")
normal=$(echo -e "\033[0m")
underline=$(echo -e "\033[4m")

script_path=$(dirname ${BASH_SOURCE[0]})

fetch_filtered_prs() {
  printf "\n${bold}$1${normal}\n\n"
  pr_lines=""
  for repo in "${REPOS[@]}"
  do
    start_spinner "Fetching PRs from ${repo}..."
    lines_to_add=$(
      gh pr list \
        --limit 10 \
        --repo "${repo}" \
        --search "$2 sort:updated-desc" \
        --json "${fields}" \
        --template "$(cat $script_path/template.txt | xargs)" \
    )
    pr_lines=$(echo -e "${pr_lines}${lines_to_add}" | sed 's/^[[:blank:]]*//')
    stop_spinner 0
  done

  trimmed=$(echo $pr_lines | tr -s " ")
  if [ -z "$trimmed" ]
  then
    echo -e "No PRs matching the given filters...\c"
    echo ""
  else
    header=$(echo "${normal}${normal}${normal}${underline}Status |  Title |  Repo |  Author |  Last Updated |  URL${normal}")
    echo -e "$header\n$pr_lines" | column -s '|' -t
  fi
}

trap "stop_spinner 0; exit" SIGHUP SIGINT SIGTERM

fetch_filtered_prs "My Pull Requests" author:@me
fetch_filtered_prs "Needs My Review" assignee:@me
fetch_filtered_prs "Subscribed" -author:@me

